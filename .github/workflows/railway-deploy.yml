name: Deploy to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.5'
        bundler-cache: true
        working-directory: ./backend
        
    - name: Install Railway CLI
      run: |
        echo "ğŸ“¦ Installing Railway CLI..."
        npm install -g @railway/cli
        echo "ğŸ” Verifying Railway CLI installation..."
        railway --help | head -5 || railway help | head -5 || echo "Railway CLI installed"
        echo "âœ… Railway CLI ready for use"
      
    - name: Validate Backend Environment
      run: |
        echo "Validating backend configuration..."
        if [ ! -f "config/master.key" ]; then
          echo "âŒ config/master.key not found"
          exit 1
        fi
        echo "âœ… Backend validation passed"
        echo "ğŸ“‹ Backend files:"
        ls -la config/ | head -10
      working-directory: ./backend

    - name: Railway Authentication & Project Setup
      run: |
        echo "ğŸ” Authenticating with Railway..."
        if [ -z "$RAILWAY_TOKEN" ]; then
          echo "âŒ RAILWAY_TOKEN not found in secrets"
          echo "Please set RAILWAY_TOKEN in GitHub repository secrets"
          exit 1
        fi
        
        echo "ğŸ” Checking Railway authentication..."
        railway login --token $RAILWAY_TOKEN || {
          echo "âŒ Railway authentication failed"
          exit 1
        }
        
        echo "ğŸ“‹ Railway projects:"
        railway list || railway projects || echo "No projects found or authentication issue"
        
        # Railway í”„ë¡œì íŠ¸ ì—°ê²° ì‹œë„ (í”„ë¡œì íŠ¸ IDê°€ ì„¤ì •ëœ ê²½ìš°)
        if [ -n "$RAILWAY_PROJECT_ID" ]; then
          echo "ğŸ”— Linking to Railway project: $RAILWAY_PROJECT_ID"
          railway link $RAILWAY_PROJECT_ID || {
            echo "âš ï¸ Failed to link to project, continuing anyway..."
          }
        else
          echo "â„¹ï¸ RAILWAY_PROJECT_ID not set, manual project linking required"
        fi
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

    - name: Deploy Backend to Railway
      run: |
        echo "ğŸš€ Attempting Backend Service deployment..."
        
        # í”„ë¡œì íŠ¸ ì—°ê²° ìƒíƒœ í™•ì¸
        if railway status; then
          echo "âœ… Railway project connected"
        else
          echo "âŒ No Railway project connected"
          echo "Please create a Railway project and set up the connection"
          echo "Visit: https://railway.app to create a project"
          echo "Then set RAILWAY_PROJECT_ID in GitHub secrets"
          exit 1
        fi
        
        # ì„œë¹„ìŠ¤ ë°°í¬ ì‹œë„
        echo "ğŸ“¤ Deploying backend service..."
        railway up --detach || {
          echo "âŒ Backend deployment failed"
          echo "ğŸ“‹ Railway status:"
          railway status || true
          echo "ğŸ“‹ Available services:"
          railway service || railway services || echo "No services found"
          exit 1
        }
        
        echo "âœ… Backend deployment initiated successfully"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      working-directory: ./backend

    - name: Wait for Backend Deployment
      run: |
        echo "â³ Waiting for backend deployment to complete..."
        sleep 30
        # Health check will be performed after both services are deployed

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.5'
        bundler-cache: true
        working-directory: ./frontend
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      working-directory: ./frontend
      
    - name: Build CSS
      run: npm run build:css
      working-directory: ./frontend

    - name: Validate Frontend Environment
      run: |
        echo "Validating frontend configuration..."
        if [ ! -f "config/master.key" ]; then
          echo "âŒ config/master.key not found"
          exit 1
        fi
        echo "âœ… Frontend validation passed"
      working-directory: ./frontend
      
    - name: Install Railway CLI
      run: |
        echo "ğŸ“¦ Installing Railway CLI..."
        npm install -g @railway/cli
        echo "ğŸ” Verifying Railway CLI installation..."
        railway --help | head -5 || railway help | head -5 || echo "Railway CLI installed"
        echo "âœ… Railway CLI ready for use"

    - name: Railway Authentication & Project Setup
      run: |
        echo "ğŸ” Authenticating with Railway..."
        railway login --token $RAILWAY_TOKEN || {
          echo "âŒ Railway authentication failed"
          exit 1
        }
        
        # Railway í”„ë¡œì íŠ¸ ì—°ê²° (ë°±ì—”ë“œì—ì„œ ì´ë¯¸ ì„¤ì •ëœ í”„ë¡œì íŠ¸ ì‚¬ìš©)
        if [ -n "$RAILWAY_PROJECT_ID" ]; then
          echo "ğŸ”— Linking to Railway project: $RAILWAY_PROJECT_ID"
          railway link $RAILWAY_PROJECT_ID || {
            echo "âŒ Failed to link to project"
            exit 1
          }
        else
          echo "âŒ RAILWAY_PROJECT_ID not set"
          exit 1
        fi
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      
    - name: Deploy Frontend to Railway
      run: |
        echo "ğŸš€ Attempting Frontend Service deployment..."
        
        # í”„ë¡œì íŠ¸ ì—°ê²° ìƒíƒœ ì¬í™•ì¸
        if ! railway status; then
          echo "âŒ Railway project not connected"
          exit 1
        fi
        
        # í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ë°°í¬
        echo "ğŸ“¤ Deploying frontend service..."
        railway up --detach || {
          echo "âŒ Frontend deployment failed"
          echo "ğŸ“‹ Railway status:"
          railway status || true
          exit 1
        }
        
        echo "âœ… Frontend deployment initiated successfully"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      working-directory: ./frontend

    - name: Wait for Frontend Deployment
      run: |
        echo "â³ Waiting for frontend deployment to complete..."
        sleep 30

  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
    
    steps:
    - name: Wait for Services to Start
      run: |
        echo "â³ Waiting for services to fully start..."
        sleep 60

    - name: Health Check Backend
      run: |
        echo "ğŸ” Checking backend health..."
        # ì‹¤ì œ ë°°í¬ì—ì„œëŠ” BACKEND_URLì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
        # curl -f https://your-backend.railway.app/up || exit 1
        echo "Backend health check skipped (add actual URL after deployment)"

    - name: Health Check Frontend
      run: |
        echo "ğŸ” Checking frontend health..."
        # ì‹¤ì œ ë°°í¬ì—ì„œëŠ” FRONTEND_URLì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
        # curl -f https://your-frontend.railway.app/ || exit 1
        echo "Frontend health check skipped (add actual URL after deployment)"

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, health-check]
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success' && (needs.health-check.result == 'success' || needs.health-check.result == 'skipped')
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "âœ… Backend deployed to Railway"
        echo "âœ… Frontend deployed to Railway"
        echo "ğŸ” Health checks completed"
        
    - name: Notify Failure  
      if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure' || needs.health-check.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "Backend status: ${{ needs.deploy-backend.result }}"
        echo "Frontend status: ${{ needs.deploy-frontend.result }}"
        echo "Health check status: ${{ needs.health-check.result }}"
        echo "Check logs for details"
        exit 1